<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<style>
  #map { width: currentWidth; height: currentHeight; }
</style>
<div id="map"></div>
<script>
  mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [144.9631, -37.8136], // Melbourne
    zoom: 6
  });

  map.on('load', () => {
    fetch('your-geojson-file.geojson')
      .then((res) => res.json())
      .then((data) => {
        map.addSource('districts', {
          type: 'geojson',
          data: data
        });

        // Add base layer with placeholder color
        map.addLayer({
          id: 'districts-fill',
          type: 'fill',
          source: 'districts',
          layout: {},
          paint: {
            'fill-color': [
              'match',
              ['get', 'district'],
              '', '#cccccc',
              '#cccccc'
            ],
            'fill-opacity': 0.8
          }
        });

        // Add outlines
        map.addLayer({
          id: 'districts-outline',
          type: 'line',
          source: 'districts',
          layout: {},
          paint: {
            'line-color': '#333',
            'line-width': 1
          }
        });

        // Hover effect
        let hoveredDistrict = null;
        map.on('mousemove', 'districts-fill', (e) => {
          const feature = e.features[0];
          if (feature) {
            hoveredDistrict = feature.properties.district;
            map.setPaintProperty('districts-fill', 'fill-opacity', [
              'match',
              ['get', 'district'],
              hoveredDistrict, 1,
              0.5
            ]);
          }
        });

        map.on('mouseleave', 'districts-fill', () => {
          hoveredDistrict = null;
          map.setPaintProperty('districts-fill', 'fill-opacity', 0.8);
        });

        // Link CMS to map: fly to feature
        document.querySelectorAll('[data-district]').forEach((el) => {
          el.addEventListener('click', () => {
            const districtName = el.getAttribute('data-district');
            const feature = data.features.find(
              (f) => f.properties.district === districtName
            );
            if (feature) {
              const center = turf.center(feature).geometry.coordinates;
              map.flyTo({ center, zoom: 10 });
            }
          });
        });

        // Match color to CMS entries
        const fillExpression = ['match', ['get', 'district']];
        document.querySelectorAll('[data-district][data-party-color]').forEach((el) => {
          const district = el.getAttribute('data-district');
          const color = el.getAttribute('data-party-color');
          fillExpression.push(district, color);
        });
        fillExpression.push('#cccccc'); // fallback color

        map.setPaintProperty('districts-fill', 'fill-color', fillExpression);
      });
  });
</script>
